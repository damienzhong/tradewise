<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.damien.tradewise.common.mapper.TwTraderOrderMapper">

    <resultMap id="BaseResultMap" type="com.damien.tradewise.common.entity.TwTraderOrder">
        <id column="id" property="id"/>
        <result column="trader_id" property="traderId"/>
        <result column="exchange" property="exchange"/>
        <result column="order_id" property="orderId"/>
        <result column="symbol" property="symbol"/>
        <result column="side" property="side"/>
        <result column="position_side" property="positionSide"/>
        <result column="action_type" property="actionType"/>
        <result column="avg_price" property="avgPrice"/>
        <result column="executed_qty" property="executedQty"/>
        <result column="total_value" property="totalValue"/>
        <result column="realized_pnl" property="realizedPnl"/>
        <result column="order_time" property="orderTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="created_at" property="createdAt"/>
        <result column="trader_name" property="traderName"/>
        <result column="avatar_url" property="avatarUrl"/>
    </resultMap>

    <select id="selectByPage" resultMap="BaseResultMap">
        SELECT o.*, t.trader_name, t.avatar_url
        FROM tw_trader_order o
        LEFT JOIN tw_trader_config t ON o.trader_id = t.id
        <where>
            <if test="traderId != null">AND o.trader_id = #{traderId}</if>
            <if test="symbol != null and symbol != ''">AND o.symbol LIKE CONCAT('%', #{symbol}, '%')</if>
            <if test="side != null and side != ''">AND o.side = #{side}</if>
            <if test="date != null">AND DATE(o.order_time) = #{date}</if>
        </where>
        ORDER BY o.order_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByCondition" resultType="int">
        SELECT COUNT(*)
        FROM tw_trader_order o
        <where>
            <if test="traderId != null">AND o.trader_id = #{traderId}</if>
            <if test="symbol != null and symbol != ''">AND o.symbol LIKE CONCAT('%', #{symbol}, '%')</if>
            <if test="side != null and side != ''">AND o.side = #{side}</if>
            <if test="date != null">AND DATE(o.order_time) = #{date}</if>
        </where>
    </select>

    <select id="selectByUserSubscriptions" resultMap="BaseResultMap">
        SELECT o.*, t.trader_name, t.avatar_url
        FROM tw_trader_order o
        INNER JOIN tw_user_trader_subscription s ON o.trader_id = s.trader_id
        LEFT JOIN tw_trader_config t ON o.trader_id = t.id
        <where>
            s.user_id = #{userId} AND s.status = 'ACTIVE'
            <if test="traderId != null">AND o.trader_id = #{traderId}</if>
            <if test="symbol != null and symbol != ''">AND o.symbol LIKE CONCAT('%', #{symbol}, '%')</if>
            <if test="side != null and side != ''">AND o.side = #{side}</if>
            <if test="date != null">AND DATE(o.order_time) = #{date}</if>
        </where>
        ORDER BY o.order_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByUserSubscriptions" resultType="int">
        SELECT COUNT(*)
        FROM tw_trader_order o
        INNER JOIN tw_user_trader_subscription s ON o.trader_id = s.trader_id
        <where>
            s.user_id = #{userId} AND s.status = 'ACTIVE'
            <if test="traderId != null">AND o.trader_id = #{traderId}</if>
            <if test="symbol != null and symbol != ''">AND o.symbol LIKE CONCAT('%', #{symbol}, '%')</if>
            <if test="side != null and side != ''">AND o.side = #{side}</if>
            <if test="date != null">AND DATE(o.order_time) = #{date}</if>
        </where>
    </select>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT o.*, t.trader_name, t.avatar_url
        FROM tw_trader_order o
        LEFT JOIN tw_trader_config t ON o.trader_id = t.id
        WHERE o.id = #{id}
    </select>

    <select id="selectStatistics" resultType="map">
        SELECT
            COUNT(*) as totalOrders,
            SUM(CASE WHEN DATE(order_time) = CURDATE() THEN 1 ELSE 0 END) as todayOrders,
            COUNT(DISTINCT trader_id) as activeTraders
        FROM tw_trader_order
    </select>

    <insert id="insert" parameterType="com.damien.tradewise.common.entity.TwTraderOrder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tw_trader_order (
            trader_id, exchange, order_id, symbol, side, position_side, action_type,
            avg_price, executed_qty, total_value, realized_pnl,
            order_time, update_time
        ) VALUES (
            #{traderId}, #{exchange}, #{orderId}, #{symbol}, #{side}, #{positionSide}, #{actionType},
            #{avgPrice}, #{executedQty}, #{totalValue}, #{realizedPnl},
            #{orderTime}, #{updateTime}
        )
    </insert>

    <select id="existsByExchangeAndOrderId" resultType="int">
        SELECT COUNT(*)
        FROM tw_trader_order
        WHERE exchange = #{exchange} AND order_id = #{orderId}
    </select>

</mapper>
