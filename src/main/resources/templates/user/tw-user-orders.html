<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的订阅订单 - TradeWise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .order-card { border-left: 4px solid #0d6efd; transition: all 0.3s; }
        .order-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .trader-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .badge-buy { background-color: #198754; }
        .badge-sell { background-color: #dc3545; }
        .direction-icon { font-size: 24px; }
        .direction-icon.up { color: #198754; }
        .direction-icon.down { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/user/dashboard">TradeWise</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/user/subscriptions">我的订阅</a>
                <a class="nav-link active" href="/user/orders">订单记录</a>
                <a class="nav-link" href="/user/profile">个人中心</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-inbox"></i> 我订阅的交易员订单</h2>
        </div>

        <!-- 筛选区域 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <select class="form-select" id="traderFilter">
                            <option value="">全部订阅</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="symbolFilter" placeholder="交易对">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="sideFilter">
                            <option value="">全部方向</option>
                            <option value="BUY">买入</option>
                            <option value="SELL">卖出</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchOrders()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 订单列表 -->
        <div id="orderList">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>

        <!-- 加载更多 -->
        <div class="text-center my-4" id="loadMoreContainer" style="display: none;">
            <button class="btn btn-outline-primary" onclick="loadMore()">
                <i class="bi bi-arrow-down-circle"></i> 加载更多
            </button>
        </div>
    </div>

    <!-- 订单详情弹窗 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let hasMore = true;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
            loadOrders();
        });

        // 加载订阅列表
        function loadSubscriptions() {
            fetch('/user/subscriptions/list')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('traderFilter');
                    data.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.traderId;
                        option.textContent = sub.traderName;
                        select.appendChild(option);
                    });
                });
        }

        // 加载订单列表
        function loadOrders(append = false) {
            const traderId = document.getElementById('traderFilter').value;
            const symbol = document.getElementById('symbolFilter').value;
            const side = document.getElementById('sideFilter').value;
            const date = document.getElementById('dateFilter').value;

            const params = new URLSearchParams({
                page: currentPage,
                size: pageSize,
                ...(traderId && {traderId}),
                ...(symbol && {symbol}),
                ...(side && {side}),
                ...(date && {date})
            });

            fetch(`/user/orders/list?${params}`)
                .then(res => res.json())
                .then(data => {
                    renderOrderCards(data.content, append);
                    hasMore = !data.last;
                    document.getElementById('loadMoreContainer').style.display = hasMore ? 'block' : 'none';
                });
        }

        // 渲染订单卡片
        function renderOrderCards(orders, append = false) {
            const container = document.getElementById('orderList');
            
            if (!append) {
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
                            <p class="text-muted mt-3">暂无订单记录</p>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = '';
            }

            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'card order-card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <div class="d-flex align-items-center">
                                    <img src="${order.avatarUrl || '/images/default-avatar.png'}" 
                                         class="trader-avatar me-2" alt="${order.traderName}">
                                    <strong>${order.traderName}</strong>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <strong>${order.symbol}</strong>
                            </div>
                            <div class="col-md-2">
                                <span class="badge badge-${order.actionType === '开多' || order.actionType === '平空' ? 'buy' : 'sell'}">${order.actionType}</span>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">均价</small><br>
                                <strong>${order.avgPrice ? order.avgPrice.toFixed(4) : '-'} USDT</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">成交数量</small><br>
                                <strong>${order.executedQty ? order.executedQty.toFixed(4) : '-'}</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">总价值</small><br>
                                <strong>${order.totalValue ? order.totalValue.toFixed(2) : '-'} USDT</strong>
                            </div>
                            <div class="col-md-1">
                                <span class="badge bg-success">已成交</span>
                            </div>
                            <div class="col-md-1 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDetail(${order.id})">
                                    详情
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${formatDateTime(order.orderTime)}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 搜索订单
        function searchOrders() {
            currentPage = 1;
            loadOrders(false);
        }

        // 加载更多
        function loadMore() {
            currentPage++;
            loadOrders(true);
        }

        // 查看详情
        function viewDetail(orderId) {
            fetch(`/user/orders/detail/${orderId}`)
                .then(res => res.json())
                .then(order => {
                    document.getElementById('orderDetailContent').innerHTML = `
                        <table class="table">
                            <tr><th>订单ID</th><td>${order.orderId}</td></tr>
                            <tr><th>交易员</th><td>${order.traderName}</td></tr>
                            <tr><th>交易对</th><td>${order.symbol}</td></tr>
                            <tr><th>操作类型</th><td>${order.actionType}</td></tr>
                            <tr><th>均价</th><td>${order.avgPrice ? order.avgPrice.toFixed(4) : '-'} USDT</td></tr>
                            <tr><th>成交数量</th><td>${order.executedQty ? order.executedQty.toFixed(4) : '-'}</td></tr>
                            <tr><th>总价值</th><td>${order.totalValue ? order.totalValue.toFixed(2) : '-'} USDT</td></tr>
                            <tr><th>已实现盈亏</th><td class="${order.realizedPnl > 0 ? 'text-success' : order.realizedPnl < 0 ? 'text-danger' : ''}">${order.realizedPnl ? order.realizedPnl.toFixed(2) + ' USDT' : ''}</td></tr>
                            <tr><th>订单时间</th><td>${formatDateTime(order.orderTime)}</td></tr>
                        </table>
                    `;
                    new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
                });
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {hour12: false});
        }
    </script>
</body>
</html>
