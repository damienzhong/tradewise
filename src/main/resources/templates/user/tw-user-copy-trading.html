<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>è·Ÿå•äº¤æ˜“ - TradeWise</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .container { margin-left: 200px; margin-top: 60px; padding: 32px; transition: margin-left 0.3s ease; }
        .container.sidebar-collapsed { margin-left: 0; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0; }
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 16px; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: #667eea; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .card h2 { margin-bottom: 20px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        
        /* äº¤æ˜“å‘˜å¡ç‰‡æ ·å¼ */
        .trader-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .trader-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #667eea; transition: all 0.3s; }
        .trader-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .trader-header { display: flex; align-items: center; margin-bottom: 15px; }
        .trader-avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .trader-info h3 { margin: 0; font-size: 18px; color: #333; }
        .trader-info p { margin: 5px 0 0 0; font-size: 12px; color: #999; }
        .trader-stats { display: flex; gap: 15px; margin: 15px 0; }
        .stat-item { flex: 1; text-align: center; padding: 10px; background: #f5f7fa; border-radius: 6px; }
        .stat-item .label { font-size: 12px; color: #666; }
        .stat-item .value { font-size: 18px; font-weight: 600; color: #333; margin-top: 5px; }
        .trader-actions { display: flex; gap: 10px; }
        
        /* è®¢é˜…åˆ—è¡¨æ ·å¼ */
        .subscription-list { display: flex; flex-direction: column; gap: 15px; }
        .subscription-card { background: white; border-radius: 8px; padding: 20px; border: 1px solid #e0e0e0; border-left: 4px solid #28a745; transition: all 0.3s; }
        .subscription-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sub-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .sub-info { display: flex; align-items: center; flex: 1; }
        .trader-details h3 { margin: 0; font-size: 16px; color: #333; }
        .trader-details p { margin: 5px 0 0 0; font-size: 12px; color: #999; }
        .sub-stats { display: flex; gap: 15px; margin: 15px 0; }
        .stat-badge { padding: 6px 12px; background: #f5f7fa; border-radius: 6px; font-size: 12px; color: #666; }
        .sub-actions { display: flex; gap: 10px; align-items: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; flex: 1; }
        .btn-secondary { background: #e0e0e0; color: #666; flex: 1; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .pagination button { padding: 8px 12px; border: 1px solid #e0e0e0; background: white; cursor: pointer; border-radius: 4px; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
    </style>
</head>
<body data-page="copy-trading">
    <div th:replace="user/components/tw-user-sidebar :: ~{}"></div>
    <div th:replace="user/components/tw-user-topbar :: ~{}"></div>
    
    <div class="container" id="mainContainer">
        <h1 style="margin-bottom: 24px; color: #333;">ğŸ“ˆ è·Ÿå•äº¤æ˜“</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('traders')">äº¤æ˜“å‘˜</button>
            <button class="tab" onclick="switchTab('subscriptions')">æˆ‘çš„è®¢é˜…</button>
            <button class="tab" onclick="switchTab('orders')">è®¢å•è®°å½•</button>
        </div>
        
        <!-- Tab 1: äº¤æ˜“å‘˜ -->
        <div id="traders-tab" class="tab-content active">
            <div class="card">
                <h2>æµè§ˆäº¤æ˜“å‘˜</h2>
                <div class="trader-grid" id="traderGrid">
                    <div style="text-align: center; padding: 40px; grid-column: 1/-1;">åŠ è½½ä¸­...</div>
                </div>
                <div class="pagination" id="traderPagination"></div>
            </div>
        </div>
        
        <!-- Tab 2: æˆ‘çš„è®¢é˜… -->
        <div id="subscriptions-tab" class="tab-content">
            <div class="card">
                <h2>è®¢é˜…åˆ—è¡¨</h2>
                <div class="subscription-list" id="subscriptionList">
                    <div style="text-align: center; padding: 40px; color: #999;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: è®¢å•è®°å½• -->
        <div id="orders-tab" class="tab-content">
            <div class="card">
                <h2>è®¢å•è®°å½•</h2>
                <div style="text-align: center; padding: 60px; color: #999;">
                    <div style="font-size: 48px;">ğŸ“‹</div>
                    <p style="margin-top: 15px;">è®¢å•è®°å½•åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentTraderPage = 1;
        
        // Tabåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'traders' && !window.tradersLoaded) {
                loadTraders();
                window.tradersLoaded = true;
            } else if (tabName === 'subscriptions' && !window.subscriptionsLoaded) {
                loadSubscriptions();
                window.subscriptionsLoaded = true;
            }
        }
        
        // åŠ è½½äº¤æ˜“å‘˜
        async function loadTraders(page = 1) {
            const res = await fetch(`/user/subscriptions/traders?page=${page}&size=12`);
            const data = await res.json();
            if (data.success) {
                renderTraders(data.traders);
                renderTraderPagination(data.page, data.totalPages);
                currentTraderPage = page;
            }
        }
        
        function renderTraders(traders) {
            const grid = document.getElementById('traderGrid');
            if (traders.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1/-1; color: #999;">æš‚æ— äº¤æ˜“å‘˜</div>';
                return;
            }
            grid.innerHTML = traders.map(t => `
                <div class="trader-card">
                    <div class="trader-header">
                        <img src="${t.avatarUrl || '/images/default-avatar.png'}" class="trader-avatar" alt="${t.traderName}">
                        <div class="trader-info">
                            <h3>${t.traderName}</h3>
                            <p>${t.description || 'æš‚æ— æè¿°'}</p>
                        </div>
                    </div>
                    <div class="trader-stats">
                        <div class="stat-item">
                            <div class="label">ç´¯è®¡è®¢å•</div>
                            <div class="value">${t.totalOrders || 0}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">ä»Šæ—¥è®¢å•</div>
                            <div class="value">${t.todayOrders || 0}</div>
                        </div>
                    </div>
                    <div class="trader-actions">
                        ${t.subscribed ? 
                            `<button class="btn btn-secondary" onclick="unsubscribe(${t.id})">å·²è®¢é˜…</button>` :
                            `<button class="btn btn-primary" onclick="subscribe(${t.id})">è®¢é˜…</button>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function renderTraderPagination(current, total) {
            const pagination = document.getElementById('traderPagination');
            let html = `<button onclick="loadTraders(${current - 1})" ${current === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
                    html += `<button class="${i === current ? 'active' : ''}" onclick="loadTraders(${i})">${i}</button>`;
                }
            }
            html += `<button onclick="loadTraders(${current + 1})" ${current === total ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            pagination.innerHTML = html;
        }
        
        async function subscribe(traderId) {
            const res = await fetch(`/user/subscriptions/subscribe/${traderId}`, { method: 'POST' });
            const data = await res.json();
            alert(data.message || (data.success ? 'è®¢é˜…æˆåŠŸï¼' : 'è®¢é˜…å¤±è´¥'));
            if (data.success) {
                loadTraders(currentTraderPage);
                window.subscriptionsLoaded = false;
            }
        }
        
        async function unsubscribe(traderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè®¢é˜…å—ï¼Ÿ')) return;
            const res = await fetch(`/user/subscriptions/unsubscribe/${traderId}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message || (data.success ? 'å–æ¶ˆè®¢é˜…æˆåŠŸï¼' : 'å–æ¶ˆè®¢é˜…å¤±è´¥'));
            if (data.success) {
                loadTraders(currentTraderPage);
                window.subscriptionsLoaded = false;
            }
        }
        
        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions() {
            const res = await fetch('/user/subscriptions/my');
            const data = await res.json();
            if (data.success) renderSubscriptions(data.subscriptions);
        }
        
        function renderSubscriptions(subscriptions) {
            const list = document.getElementById('subscriptionList');
            if (subscriptions.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">ğŸ“­</div>
                        <p>æ‚¨è¿˜æ²¡æœ‰è®¢é˜…ä»»ä½•äº¤æ˜“å‘˜</p>
                        <button class="btn btn-primary" style="margin-top: 15px;" onclick="switchTab('traders'); document.querySelectorAll('.tab')[0].click();">å»è®¢é˜…</button>
                    </div>
                `;
                return;
            }
            list.innerHTML = subscriptions.map(sub => `
                <div class="subscription-card">
                    <div class="sub-header">
                        <div class="sub-info">
                            <img src="${sub.avatarUrl || '/images/default-avatar.png'}" class="trader-avatar" style="width: 50px; height: 50px;" alt="${sub.traderName}">
                            <div class="trader-details">
                                <h3>${sub.traderName}</h3>
                                <p>${sub.description || 'æš‚æ— æè¿°'}</p>
                            </div>
                        </div>
                        <div class="sub-actions">
                            <label style="font-size: 12px; color: #666; margin-right: 10px;">
                                é‚®ä»¶é€šçŸ¥
                                <label class="switch" style="margin-left: 8px;">
                                    <input type="checkbox" ${sub.notifyEmail ? 'checked' : ''} onchange="toggleNotify(${sub.traderId}, this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <button class="btn btn-danger" onclick="unsubscribeFromList(${sub.traderId})">å–æ¶ˆè®¢é˜…</button>
                        </div>
                    </div>
                    <div class="sub-stats">
                        <span class="stat-badge">ğŸ“Š ç´¯è®¡è®¢å•: ${sub.totalOrders || 0}</span>
                        <span class="stat-badge">ğŸ“… ä»Šæ—¥è®¢å•: ${sub.todayOrders || 0}</span>
                        <span class="stat-badge">ğŸ• è®¢é˜…æ—¶é—´: ${formatDate(sub.subscribedAt)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function toggleNotify(traderId, enabled) {
            const res = await fetch(`/user/subscriptions/update/${traderId}?notifyEmail=${enabled}&status=ACTIVE`, { method: 'PUT' });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || 'æ›´æ–°å¤±è´¥');
                loadSubscriptions();
            }
        }
        
        async function unsubscribeFromList(traderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè®¢é˜…å—ï¼Ÿå–æ¶ˆåå°†ä¸å†æ”¶åˆ°è¯¥äº¤æ˜“å‘˜çš„è®¢å•é€šçŸ¥ã€‚')) return;
            const res = await fetch(`/user/subscriptions/unsubscribe/${traderId}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message || (data.success ? 'å–æ¶ˆè®¢é˜…æˆåŠŸï¼' : 'å–æ¶ˆè®¢é˜…å¤±è´¥'));
            if (data.success) {
                loadSubscriptions();
                window.tradersLoaded = false;
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }
        
        // åˆå§‹åŠ è½½
        loadTraders();
        window.tradersLoaded = true;
    </script>
    <script th:replace="user/components/tw-user-common-script :: ~{}"></script>
</body>
</html>
