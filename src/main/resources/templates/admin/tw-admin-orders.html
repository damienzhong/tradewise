<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易员订单监控 - TradeWise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .main-container { margin-left: 200px; padding: 20px; transition: margin-left 0.3s; }
        .main-container.sidebar-collapsed { margin-left: 0; }
        .stats-card { border-left: 4px solid; }
        .stats-card.primary { border-color: #0d6efd; }
        .stats-card.success { border-color: #198754; }
        .stats-card.info { border-color: #0dcaf0; }
        .badge-buy { background-color: #198754; }
        .badge-sell { background-color: #dc3545; }
        .badge-long { background-color: #0d6efd; }
        .badge-short { background-color: #fd7e14; }
    </style>
</head>
<body data-page="orders">
    <div th:replace="admin/components/tw-admin-sidebar :: ~{}"></div>
    <div th:replace="admin/components/tw-admin-topbar :: ~{}"></div>

    <div class="main-container" id="mainContainer">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up"></i> 交易员订单监控</h2>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card primary">
                    <div class="card-body">
                        <h6 class="text-muted">今日订单</h6>
                        <h3 id="todayOrders">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card success">
                    <div class="card-body">
                        <h6 class="text-muted">活跃交易员</h6>
                        <h3 id="activeTraders">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card info">
                    <div class="card-body">
                        <h6 class="text-muted">累计订单</h6>
                        <h3 id="totalOrders">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筛选区域 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <select class="form-select" id="traderFilter">
                            <option value="">全部交易员</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="symbolFilter" placeholder="交易对">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="sideFilter">
                            <option value="">全部方向</option>
                            <option value="BUY">买入</option>
                            <option value="SELL">卖出</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchOrders()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 订单列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>交易员</th>
                                <th>交易对</th>
                                <th>操作类型</th>
                                <th>均价 (USDT)</th>
                                <th>成交数量</th>
                                <th>总价值 (USDT)</th>
                                <th>已实现盈亏 (USDT)</th>
                                <th>订单时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                            <tr>
                                <td colspan="10" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 订单详情弹窗 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{admin/components/tw-admin-common-script :: common-script}"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadTraders();
            loadOrders();
        });

        // 加载统计数据
        function loadStatistics() {
            fetch('/admin/orders/statistics')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('todayOrders').textContent = data.todayOrders || 0;
                    document.getElementById('activeTraders').textContent = data.activeTraders || 0;
                    document.getElementById('totalOrders').textContent = data.totalOrders || 0;
                });
        }

        // 加载交易员列表
        function loadTraders() {
            fetch('/admin/traders/list?page=1&pageSize=100')
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        const select = document.getElementById('traderFilter');
                        result.data.traders.forEach(trader => {
                            const option = document.createElement('option');
                            option.value = trader.id;
                            option.textContent = trader.traderName;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(err => console.error('加载交易员列表失败:', err));
        }

        // 加载订单列表
        function loadOrders(page = 1) {
            currentPage = page;
            const traderId = document.getElementById('traderFilter').value;
            const symbol = document.getElementById('symbolFilter').value;
            const side = document.getElementById('sideFilter').value;
            const date = document.getElementById('dateFilter').value;

            const params = new URLSearchParams({
                page: page,
                size: pageSize,
                ...(traderId && {traderId}),
                ...(symbol && {symbol}),
                ...(side && {side}),
                ...(date && {date})
            });

            fetch(`/admin/orders/list?${params}`)
                .then(res => res.json())
                .then(data => {
                    renderOrderTable(data.content);
                    renderPagination(data.totalPages, page);
                });
        }

        // 渲染订单表格
        function renderOrderTable(orders) {
            const tbody = document.getElementById('orderTableBody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.id}</td>
                    <td>${order.traderName}</td>
                    <td><strong>${order.symbol}</strong></td>
                    <td><span class="badge badge-${order.actionType === '开多' || order.actionType === '平空' ? 'buy' : 'sell'}">${order.actionType}</span></td>
                    <td>${order.avgPrice ? order.avgPrice.toFixed(4) : '-'}</td>
                    <td>${order.executedQty ? order.executedQty.toFixed(4) : '-'}</td>
                    <td>${order.totalValue ? order.totalValue.toFixed(2) : '-'}</td>
                    <td class="${order.realizedPnl > 0 ? 'text-success' : order.realizedPnl < 0 ? 'text-danger' : ''}">${order.realizedPnl ? order.realizedPnl.toFixed(2) : '-'}</td>
                    <td>${formatDateTime(order.orderTime)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetail(${order.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 渲染分页
        function renderPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            if (currentPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${currentPage - 1}); return false;">上一页</a></li>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else if (Math.abs(i - currentPage) <= 2 || i === 1 || i === totalPages) {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${i}); return false;">${i}</a></li>`;
                } else if (Math.abs(i - currentPage) === 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${currentPage + 1}); return false;">下一页</a></li>`;
            }
            
            pagination.innerHTML = html;
        }

        // 搜索订单
        function searchOrders() {
            loadOrders(1);
        }

        // 查看详情
        function viewDetail(orderId) {
            fetch(`/admin/orders/detail/${orderId}`)
                .then(res => res.json())
                .then(order => {
                    document.getElementById('orderDetailContent').innerHTML = `
                        <table class="table">
                            <tr><th>订单ID</th><td>${order.orderId}</td></tr>
                            <tr><th>交易员</th><td>${order.traderName}</td></tr>
                            <tr><th>交易对</th><td>${order.symbol}</td></tr>
                            <tr><th>操作类型</th><td>${order.actionType}</td></tr>
                            <tr><th>均价</th><td>${order.avgPrice ? order.avgPrice.toFixed(4) : '-'} USDT</td></tr>
                            <tr><th>成交数量</th><td>${order.executedQty ? order.executedQty.toFixed(4) : '-'}</td></tr>
                            <tr><th>总价值</th><td>${order.totalValue ? order.totalValue.toFixed(2) : '-'} USDT</td></tr>
                            <tr><th>已实现盈亏</th><td class="${order.realizedPnl > 0 ? 'text-success' : order.realizedPnl < 0 ? 'text-danger' : ''}">${order.realizedPnl ? order.realizedPnl.toFixed(2) + ' USDT' : ''}</td></tr>
                            <tr><th>订单时间</th><td>${formatDateTime(order.orderTime)}</td></tr>
                            <tr><th>更新时间</th><td>${formatDateTime(order.updateTime)}</td></tr>
                        </table>
                    `;
                    new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
                });
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {hour12: false});
        }
    </script>
</body>
</html>
