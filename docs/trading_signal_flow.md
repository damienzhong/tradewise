# TradeWise 开单信号生成流程

## 信号生成主流程

```mermaid
flowchart TD
    A[开始分析交易对] --> B[获取K线数据]
    B --> C[计算技术指标<br/>EMA, RSI, MACD, 布林带, ATR等]
    C --> D[检测基础交易信号<br/>多指标确认策略]
    D --> E[检测高级交易信号<br/>波动率、结构、假突破等]
    E --> F[计算信号评分<br/>位置分、结构分、能量分等]
    F --> G[设置风险管理参数<br/>止损、止盈、杠杆等]
    G --> H[信号聚合与过滤<br/>频率控制、冷却机制]
    H --> I{是否发送信号?}
    I -->|是| J[生成邮件通知]
    I -->|否| K[结束]
    J --> L[发送邮件]
    L --> M[记录分析结果]
    M --> N[完成]
    K --> N
```

## 基础信号检测流程

```mermaid
flowchart TD
    A[开始检测基础信号] --> B[检查EMA金叉/死叉]
    B --> C{短期均线上穿长期均线?}
    C -->|是| D[确认趋势方向]
    C -->|否| E[检查RSI超买超卖]
    D --> F[增加做多确认计数]
    E --> G{RSI<30或RSI>70?}
    G -->|是| H[根据趋势确认信号]
    G -->|否| I[检查MACD信号]
    H --> J[增加对应信号确认计数]
    I --> K{MACD金叉/死叉?}
    K -->|是| L[增加对应信号确认计数]
    K -->|否| M[检查布林带信号]
    M --> N{价格触及轨道?}
    N -->|是| O[增加对应信号确认计数]
    N -->|否| P[确认信号数量]
    O --> P
    L --> P
    J --> P
    P --> Q{确认数>=阈值?}
    Q -->|是| R[生成基础交易信号]
    Q -->|否| S[无信号]
    R --> T[设置基础信号参数]
    T --> U[返回信号]
    S --> U
```

## 高级信号检测流程

```mermaid
flowchart TD
    A[开始检测高级信号] --> B[检测波动率信号]
    B --> C[检测结构信号]
    C --> D[检测布林带挤压]
    D --> E[检测假突破信号]
    E --> F[检测成交量异常]
    F --> G[检测复合高优先级信号]
    G --> H[检测多时间框架共振]
    H --> I[返回所有高级信号]
```

## 波动率信号检测流程

```mermaid
flowchart TD
    A[检测波动率信号] --> B[检查ATR是否连续下降]
    B --> C{ATR连续下降15根K线以上?}
    C -->|是| D[检查当前ATR是否处于近期低位]
    C -->|否| E[检查波动率突然放大]
    D --> F{ATR<=近期最低值*1.2?}
    F -->|是| G[分析价格在近期区间位置]
    F -->|否| E
    G --> H{价格在区间上半部分?}
    H -->|是| I[生成做空方向建议<br/>设置止损止盈]
    H -->|否| J[生成做多方向建议<br/>设置止损止盈]
    E --> K{K线实体>1.5倍ATR?}
    K -->|是| L[生成波动率放大信号]
    K -->|否| M[无波动率信号]
    I --> N[返回波动率信号]
    J --> N
    L --> N
    M --> N
```

## 信号评分与风险管理流程

```mermaid
flowchart TD
    A[计算信号评分] --> B[计算位置分]
    B --> C[计算结构分]
    C --> D[计算能量分]
    D --> E[计算时间分]
    E --> F[计算环境分]
    F --> G[汇总得分(0-10分)]
    G --> H[设置信号等级<br/>LEVEL_1(8-10分)<br/>LEVEL_2(6-7分)<br/>LEVEL_3(4-5分)]
    
    H --> I[风险管理参数计算]
    I --> J[计算止损位]
    J --> K[计算止盈位]
    K --> L[计算杠杆倍数]
    L --> M[计算所需保证金]
    M --> N[计算预期收益率]
    N --> O[计算预估爆仓价]
    O --> P[返回完整信号]
```

## 信号聚合与过滤流程

```mermaid
flowchart TD
    A[接收所有信号] --> B[按交易对和指标分组]
    B --> C[应用冷却机制]
    C --> D{信号是否在冷却期内?}
    D -->|是| E[过滤掉信号]
    D -->|否| F[检查信号类型]
    F --> G{是否为HOLD波动率信号?}
    G -->|是| H[应用8小时冷却时间]
    G -->|否| I[应用标准冷却时间]
    H --> J[更新最后发送时间]
    I --> J
    E --> K[返回过滤后信号]
    J --> K
```

## 邮件通知流程

```mermaid
flowchart TD
    A[生成信号后] --> B[按交易对分组信号]
    B --> C[准备邮件模板上下文]
    C --> D[填充信号数据到模板]
    D --> E[获取启用的邮箱地址列表]
    E --> F{是否有配置邮箱?}
    F -->|否| G[跳过邮件发送]
    F -->|是| H[生成HTML邮件内容]
    H --> I[设置邮件主题]
    I --> J[发送邮件]
    J --> K[记录发送日志]
    G --> L[完成]
    K --> L
```